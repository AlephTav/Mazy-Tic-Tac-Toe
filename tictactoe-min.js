// Mazy Tic-Tac-Toe v1.0
// Copyright Â© 2014 - Sergey Milimko (a.k.a. AlephTav)
// Licensed under the MIT (http://www.opensource.org/licenses/MIT) license.
var GameBoard=function(e){var t={fill:"#FFF68F","fill-opacity":.3,stroke:"#8B0000","stroke-width":4};var n={fill:"#FF4500","fill-opacity":.2,stroke:"#5D478B","stroke-width":4};var r;var i=function(e,t){this.size=parseInt(t);this.raphael=Raphael(e,this.size,this.size)};i.prototype.line=function(e,t,n,r,i,s){this.raphael.path(["M",e,t,"L",n,r]).attr({stroke:i,"stroke-width":s?s:1})};i.prototype.getBBoxPosition=function(e,t){var n=parseInt((e-this.padding)/this.bbox);var r=parseInt((t-this.padding)/this.bbox);return{x:n*this.bbox+this.padding,y:r*this.bbox+this.padding}};i.prototype.getSBoxPosition=function(e,t,n,r){var i=parseInt((e-this.padding)/this.sbox);var s=parseInt((t-this.padding)/this.sbox);return{x:n+i*this.sbox+this.padding,y:r+s*this.sbox+this.padding}};i.prototype.getBCell=function(e){return[Math.floor((e.x-this.padding)/this.bbox),Math.floor((e.y-this.padding)/this.bbox)]};i.prototype.getSCell=function(e,t){return[Math.floor((t.x-this.padding-e.x)/this.sbox),Math.floor((t.y-this.padding-e.y)/this.sbox)]};i.prototype.getCell=function(e,t){return[this.getBCell(e),this.getSCell(e,t)]};i.prototype.shape=function(e,t,i){var s;var o=[t[0][0]*this.bbox+t[1][0]*this.sbox+2*this.padding,t[0][1]*this.bbox+t[1][1]*this.sbox+2*this.padding];r.shapes.push({pos:t,game:{player:e.player,moves:e.moves,showMoveNumbers:e.showMoveNumbers}});if(e.player==1){var u=this.sbox/2,a=u/2,f=o[0]+u,l=o[1]+u;s="M"+f+","+l+"l-"+a+",-"+a;s+="M"+f+","+l+"l"+a+",-"+a;s+="M"+f+","+l+"l-"+a+","+a;s+="M"+f+","+l+"l"+a+","+a}else{var c=this.sbox/4,h=Math.floor(.45*c),p=c-h;s="M"+(o[0]+this.sbox/2)+","+(o[1]+this.sbox/4);s+="c"+p+",0 "+c+","+h+" "+c+","+c;s+="c0,"+p+" -"+h+","+c+" -"+c+","+c;s+="c-"+p+",0 -"+c+"-"+h+" -"+c+"-"+c;s+="c0-"+p+" "+h+"-"+c+" "+c+"-"+c+"z"}if(i){this.raphael.path(["M",o[0],o[1],"h",this.sbox,"v",this.sbox,"h",-this.sbox,"Z"]).attr(n).animate({path:s,fill:"none","stroke-width":this.stroke},300)}else{this.raphael.path(s).attr({fill:"none",stroke:"#5D478B","stroke-width":this.stroke})}if(e.showMoveNumbers>0)this.raphael.text(o[0]+(e.moves>9?4:3)*Math.floor(this.size/128),o[1]+7,e.moves).attr({"font-size":Math.floor(this.size/64)+"px","stroke-width":1,stroke:"#1C1C1C"})};i.prototype.winner=function(t,n){r.isWinner=true;r.winner=t;r.coordinates=n;if(n!=e){var i=n[0],s=n[1].slice(),o=n[3].slice();var u=i[0]*this.bbox+2*this.padding,a=i[1]*this.bbox+2*this.padding;if(s[0]==o[0]){u+=Math.floor(this.sbox/2);o[1]++}else if(s[1]==o[1]){a+=Math.floor(this.sbox/2);o[0]++}else{if(s[0]>o[0])s[0]++;else o[0]++;o[1]++}this.line(u+s[0]*this.sbox,a+s[1]*this.sbox,u+o[0]*this.sbox,a+o[1]*this.sbox,"#FFD700",this.stroke-1)}var f=this.size/2,l=Math.floor(this.size/16);var c=t==e?"DRAW":t==2?"NOUGHTS WIN!":"CROSSES WIN!";c=this.raphael.text(this.size/2,0,c).attr({font:l+"px Helvetica",stroke:"#00CD00"});var h=function(){c.animate({transform:"s2T0,"+f},2e3,">",function(){c.animate({transform:"s1T0,"+2*f},2e3,"<",p)})};var p=function(){c.animate({transform:"s2T0,"+f},2e3,">",function(){c.animate({transform:"s1t0,0"},2e3,"<",h)})};h()};i.prototype.init=function(){this.raphael.clear();this.padding=Math.floor(this.size*.012);this.bbox=Math.floor((this.size-2*this.padding)/3);this.sbox=Math.floor((this.bbox-2*this.padding)/3);this.stroke=parseInt(this.size*.015);this.rect=this.raphael.rect(0,0,this.size,this.size,this.padding).attr({fill:"#fff"});for(var e,t=1;t<=2;t++){e=t*this.bbox+this.padding;this.line(e,this.padding,e,this.size-this.padding,"#1C1C1C",3);this.line(this.padding,e,this.size-this.padding,e,"#1C1C1C",3)}for(var n,t=0;t<3;t++){n=t*this.bbox+2*this.padding;for(var i,e=0;e<3;e++){i=e*this.bbox+2*this.padding;for(var s=this.sbox,o=1;o<=2;o++,s+=this.sbox){this.line(n+s,i,n+s,i+this.bbox-2*this.padding,"#1C1C1C");this.line(i,n+s,i+this.bbox-2*this.padding,n+s,"#1C1C1C")}}}r={isActive:false,isWinner:false,shapes:[]}};i.prototype.resize=function(e,t){var n=r;this.size=parseInt(e);this.raphael.setSize(this.size,this.size);this.init();for(var i,s=0;s<n.shapes.length;s++){i=n.shapes[s];this.shape(i.game,i.pos)}if(n.isWinner)this.winner(n.winner,n.coordinates);else if(n.isActive)this.activate(n.events,n.boards)};i.prototype.activate=function(i,s){var o=this,u=[],a,f;var l,c,h,p;r.isActive=true;r.events=i;r.boards=s;var d=function(e){o.rect.unmousemove();if(a)a.remove();if(f)f.remove();for(var t in u)u[t].remove();r.isActive=false;i.click(o.getCell(l,c))};var v=function(t){l=t.target.getBBox();var r=false,s=t.layerX||t.offsetX,u=t.layerY||t.offsetY;if(!window.opera){s-=l.x;u-=l.y}if(s>=o.padding&&u>=o.padding&&s<=o.bbox-o.padding&&u<=o.bbox-o.padding){c=o.getSBoxPosition(s,u,l.x,l.y);var a=o.getSCell(l,c);r=a[0]<=2&&a[1]<=2}if(!r){if(f)f.remove();h=p=e;return}if(c.x!=h||c.y!=p){if(f)f.remove();if(i.move(o.getCell(l,c))){f=o.raphael.rect(c.x,c.y,o.sbox,o.sbox).attr(n);f.click(d)}h=c.x;p=c.y}};if(s==e){var m,g,y;this.rect.mousemove(function(n){var r=false,i=n.layerX||n.offsetX,s=n.layerY||n.offsetY;if(i>=o.padding&&s>=o.padding&&i<=o.size-o.padding&&s<=o.size-o.padding){m=o.getBBoxPosition(i,s);var u=o.getBCell(m);r=u[0]<=2&&u[1]<=2}if(!r){if(a)a.remove();if(f)f.remove();g=y=h=p=e;return}m=o.getBBoxPosition(i,s);if(m.x!=g||m.y!=y){if(a){a.remove();if(f)f.remove()}a=o.raphael.rect(m.x,m.y,o.bbox,o.bbox).attr(t);a.mousemove(v);g=m.x;y=m.y}})}else{for(var b,w,E=0;E<s.length;E++){w=s[E];b=this.raphael.rect(w[0]*this.bbox+this.padding,w[1]*this.bbox+this.padding,this.bbox,this.bbox).attr(t);b.mousemove(v);u.push(b)}}};return i}();var Game=function(e){var t=false;var n=function(e,t){this.board=new GameBoard(e,t);this.bot=new Bot(this);this.human=new Human(this)};n.prototype.init=function(){t=false;this.mode=0;this.moves=0;this.last=[];this.game=[];this.player=1;this.difficulty=1;this.showMoveNumbers=0;this.bot.init();this.human.init();this.board.init();for(var e=0;e<81;e++)this.game[e]=0};n.prototype.getIndex=function(e){return 9*(e[0][1]*3+e[0][0])+e[1][1]*3+e[1][0]};n.prototype.isEmptyCell=function(e,t){var t=t||this.game;return t[n.prototype.getIndex(e)]==0};n.prototype.isFullBoard=function(e,t){var t=t||this.game;for(var n=0,r=9*(e[1]*3+e[0]);n<9;n++)if(t[n+r]==0)return false;return true};n.prototype.getNonFullBoards=function(e,t){var e=e||this.game;var t=t||this.last;if(!n.prototype.isFullBoard(t[1],e))return[t[1]];var r=[];for(var i=0;i<3;i++){for(var s=0;s<3;s++){if(!n.prototype.isFullBoard([i,s],e))r.push([i,s])}}return r};n.prototype.hasWinner=function(){var e=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(var t=0;t<81;t+=9){for(var n=0,r;n<8;n++){r=e[n];if(this.game[t+r[0]]==this.player&&this.game[t+r[1]]==this.player&&this.game[t+r[2]]==this.player){return[[Math.floor(t%27/9),Math.floor(t/27)],[r[0]%3,Math.floor(r[0]/3)],[r[1]%3,Math.floor(r[1]/3)],[r[2]%3,Math.floor(r[2]/3)]]}}}return false};n.prototype.cell=function(e){this.last=e;this.game[this.getIndex(this.last)]=this.player};n.prototype.move=function(){t=true;this.moves++;if(this.moves==1){if(this.mode==0||this.mode==2){this.human.move()}else if(this.mode==1||this.mode==3){this.bot.move()}}else{var e=this;this.player=this.player==1?2:1;if(this.mode==2)this.human.move();else if(this.mode==3)setTimeout(function(){e.bot.move()},500);else if(this.mode==0&&this.player==1||this.mode==1&&this.player==2)this.human.move();else this.bot.move()}};n.prototype.inGame=function(){return t};n.prototype.win=function(e){t=false;this.board.winner(this.player,e)};n.prototype.draw=function(){this.board.winner()};return n}();var Human=function(e){var t=function(e){this.game=e;this.events={}};t.prototype.init=function(){var e=this;var t=function(t){return e.game.isEmptyCell(t)};var n=function(t){e.game.board.shape(e.game,t,true);e.game.cell(t);var n=e.game.hasWinner();if(n!==false)e.game.win(n);else e.game.move()};this.events={move:t,click:n}};t.prototype.move=function(){if(this.game.moves==1){this.game.board.activate(this.events)}else{var e=this.game.getNonFullBoards();if(e.length==0)this.game.draw();else this.game.board.activate(this.events,e)}};return t}();var Bot=function(e){var t=function(e,t){return Math.floor(Math.random()*(parseInt(t)+1))+parseInt(e)};var n=function(e){this.game=e};n.prototype.init=function(){if(this.worker){this.worker.terminate();document.body.style.cursor="default"}this.logic={pppXXXXXX:1e6,XXXpppXXX:1e6,XXXXXXppp:1e6,pXXpXXpXX:1e6,XpXXpXXpX:1e6,XXpXXpXXp:1e6,pXXXpXXXp:1e6,XXpXpXpXX:1e6,pp0XXXXXX:8,p0pXXXXXX:8,"0ppXXXXXX":8,XXXpp0XXX:8,XXXp0pXXX:8,XXX0ppXXX:8,XXXXXXpp0:8,XXXXXXp0p:8,XXXXXX0pp:8,pXXpXX0XX:8,pXX0XXpXX:8,"0XXpXXpXX":8,XpXXpXX0X:8,XpXX0XXpX:8,X0XXpXXpX:8,XXpXXpXX0:8,XXpXX0XXp:8,XX0XXpXXp:8,pXXXpXXX0:8,pXXX0XXXp:8,"0XXXpXXXp":8,XXpXpX0XX:8,XXpX0XpXX:8,XX0XpXpXX:8,oopXXXXXX:16,opoXXXXXX:16,pooXXXXXX:16,XXXoopXXX:16,XXXopoXXX:16,XXXpooXXX:16,XXXXXXoop:16,XXXXXXopo:16,XXXXXXpoo:16,oXXoXXpXX:16,oXXpXXoXX:16,pXXoXXoXX:16,XoXXoXXpX:16,XoXXpXXoX:16,XpXXoXXoX:16,XXoXXoXXp:16,XXoXXpXXo:16,XXpXXoXXo:16,oXXXoXXXp:16,oXXXpXXXo:16,pXXXoXXXo:16,XXoXoXpXX:16,XXoXpXoXX:16,XXpXoXoXX:16,po0XXXXXX:4,p0oXXXXXX:4,"0poXXXXXX":4,"0opXXXXXX":4,o0pXXXXXX:4,op0XXXXXX:4,XXX0opXXX:4,XXX0poXXX:4,XXXpo0XXX:4,XXXp0oXXX:4,XXXo0pXXX:4,XXXop0XXX:4,XXXXXXp0o:4,XXXXXXpo0:4,XXXXXX0po:4,XXXXXX0op:4,XXXXXXop0:4,XXXXXXo0p:4,pXX0XXoXX:4,pXXoXX0XX:4,oXX0XXpXX:4,oXXpXX0XX:4,"0XXoXXpXX":4,"0XXpXXoXX":4,XpXX0XXoX:4,XpXXoXX0X:4,XoXX0XXpX:4,XoXXpXX0X:4,X0XXoXXpX:4,X0XXpXXoX:4,XXpXX0XXo:4,XXpXXoXX0:4,XXoXX0XXp:4,XXoXXpXX0:4,XX0XXoXXp:4,XX0XXpXXo:4,pXXX0XXXo:4,pXXXoXXX0:4,"0XXXoXXXp":4,"0XXXpXXXo":4,oXXX0XXXp:4,oXXXpXXX0:4,XXpX0XoXX:4,XXpXoX0XX:4,XX0XoXpXX:4,XX0XpXoXX:4,XXoX0XpXX:4,XXoXpX0XX:4}};n.prototype.move=function(){if(!this.game.inGame())return;document.body.style.cursor="wait";var e=this,n=function(n){document.body.style.cursor="default";if(n.length==0){e.game.draw();return}e.game.cell(n[t(0,n.length-1)]);e.game.board.shape(e.game,e.game.last,true);var r=e.game.hasWinner();if(r!==false)e.game.win(r);else e.game.move()};if(this.game.moves==1)n([[[t(0,2),t(0,2)],[t(0,2),t(0,2)]]]);else{if(!window.Worker)n(this.getOptimalMoves(this.game.getNonFullBoards()));else{this.worker=new Worker("bot.js");this.worker.addEventListener("message",function(e){n(e.data)},false);this.worker.postMessage({boards:this.game.getNonFullBoards(),game:{player:this.game.player,difficulty:this.game.difficulty,game:this.game.game,moves:this.game.moves}})}}};n.prototype.getOptimalMoves=function(e,t){var n=[],r=[],i=-1e9,t=t||this.game;var s=2*t.difficulty+1,o=t.player==2?1:2;if(s>=7){if(t.moves<=18)s=5;else if(s>=9&&t.moves<=27)s=7}for(var u,a,f,l=0;l<e.length;l++){f=e[l];for(var c=0;c<3;c++){for(var h=0;h<3;h++){a=[f,[c,h]];if(Game.prototype.isEmptyCell(a,t.game)){u=this.getMoveEstimate(a,{level:s,game:t.game.slice(),player:t.player,opposer:o});r.push([u,a]);if(u>i)i=u}}}}for(var c=0;c<r.length;c++){if(r[c][0]==i)n.push(r[c][1])}return n};n.prototype.getMoveEstimate=function(e,t){var n,r=c2=c3=c4=c5="",i=0;t.game[Game.prototype.getIndex(e)]=t.player;n=9*(3*e[0][1]+e[0][0]);for(var s,o=0;o<3;o++){for(var u=0;u<3;u++){s=t.game[n]==t.player?"p":t.game[n]==t.opposer?"o":"0";if(e[1][0]==u)r+=s;else r+="X";if(e[1][1]==o)c2+=s;else c2+="X";if(e[1][0]==e[1][1]&&o==u)c3+=s;else c3+="X";if(e[1][0]+e[1][1]==2&&o+u==2)c4+=s;else c4+="X";n++}}i+=this.logic[r]||0;i+=this.logic[c2]||0;i+=this.logic[c3]||0;i+=this.logic[c4]||0;if(t.level>0&&i<1e6){var a=Game.prototype.getNonFullBoards(t.game,e),f=-1e9;for(var l,c,h=0;h<a.length;h++){l=a[h];for(var o=0;o<3;o++){for(var u=0;u<3;u++){e=[l,[o,u]];if(Game.prototype.isEmptyCell(e,t.game)){c=this.getMoveEstimate(e,{level:t.level-1,game:t.game.slice(),player:t.opposer,opposer:t.player,factors:t.factors});if(c>f)f=c}}}}i-=f}return i};return n}();var TicTacToe=function(e){var t=function(e,t){this.game=new Game(e,t);this.game.init()};t.prototype.start=function(e){if(e<0)e=0;if(e>4)e=4;this.game.mode=e;this.game.player=1;this.game.move()};t.prototype.stop=function(){this.game.init()};return t}()