// Mazy Tic-Tac-Toe v1.0
// Copyright Â© 2014 - Sergey Milimko (a.k.a. AlephTav)
// Licensed under the MIT (http://www.opensource.org/licenses/MIT) license.
var GameBoard=(function(d){var e={fill:"#FFF68F","fill-opacity":0.3,stroke:"#8B0000","stroke-width":4};var b={fill:"#FF4500","fill-opacity":0.2,stroke:"#5D478B","stroke-width":4};var c;var a=function(f,g){this.size=parseInt(g);this.raphael=Raphael(f,this.size,this.size)};a.prototype.line=function(h,k,g,i,f,j){this.raphael.path(["M",h,k,"L",g,i]).attr({stroke:f,"stroke-width":j?j:1})};a.prototype.getBBoxPosition=function(f,k){var h=parseInt((f-this.padding)/this.bbox);var g=parseInt((k-this.padding)/this.bbox);return{x:h*this.bbox+this.padding,y:g*this.bbox+this.padding}};a.prototype.getSBoxPosition=function(g,m,h,f){var l=parseInt((g-this.padding)/this.sbox);var k=parseInt((m-this.padding)/this.sbox);return{x:h+l*this.sbox+this.padding,y:f+k*this.sbox+this.padding}};a.prototype.getBCell=function(f){return[Math.floor((f.x-this.padding)/this.bbox),Math.floor((f.y-this.padding)/this.bbox)]};a.prototype.getSCell=function(f,g){return[Math.floor((g.x-this.padding-f.x)/this.sbox),Math.floor((g.y-this.padding-f.y)/this.sbox)]};a.prototype.getCell=function(f,g){return[this.getBCell(f),this.getSCell(f,g)]};a.prototype.shape=function(q,p,g){var l;var r=[p[0][0]*this.bbox+p[1][0]*this.sbox+2*this.padding,p[0][1]*this.bbox+p[1][1]*this.sbox+2*this.padding];c.shapes.push({pos:p,game:{player:q.player,moves:q.moves,showMoveNumbers:q.showMoveNumbers}});if(q.player==1){var h=this.sbox/2,o=h/2,f=r[0]+h,n=r[1]+h;l="M"+f+","+n+"l-"+o+",-"+o;l+="M"+f+","+n+"l"+o+",-"+o;l+="M"+f+","+n+"l-"+o+","+o;l+="M"+f+","+n+"l"+o+","+o}else{var m=this.sbox/4,j=Math.floor(0.45*m),i=m-j;l="M"+(r[0]+this.sbox/2)+","+(r[1]+this.sbox/4);l+="c"+i+",0 "+m+","+j+" "+m+","+m;l+="c0,"+i+" -"+j+","+m+" -"+m+","+m;l+="c-"+i+",0 -"+m+"-"+j+" -"+m+"-"+m;l+="c0-"+i+" "+j+"-"+m+" "+m+"-"+m+"z"}if(g){this.raphael.path(["M",r[0],r[1],"h",this.sbox,"v",this.sbox,"h",-this.sbox,"Z"]).attr(b).animate({path:l,fill:"none","stroke-width":this.stroke},300)}else{this.raphael.path(l).attr({fill:"none",stroke:"#5D478B","stroke-width":this.stroke})}if(q.showMoveNumbers>0){this.raphael.text(r[0]+(q.moves>9?4:3)*Math.floor(this.size/128),r[1]+7,q.moves).attr({"font-size":Math.floor(this.size/64)+"px","stroke-width":1,stroke:"#1C1C1C"})}};a.prototype.winner=function(o,m){c.isWinner=true;c.winner=o;c.coordinates=m;if(m!=d){var j=m[0],h=m[1].slice(),n=m[3].slice();var l=j[0]*this.bbox+2*this.padding,k=j[1]*this.bbox+2*this.padding;if(h[0]==n[0]){l+=Math.floor(this.sbox/2);n[1]++}else{if(h[1]==n[1]){k+=Math.floor(this.sbox/2);n[0]++}else{if(h[0]>n[0]){h[0]++}else{n[0]++}n[1]++}}this.line(l+h[0]*this.sbox,k+h[1]*this.sbox,l+n[0]*this.sbox,k+n[1]*this.sbox,"#FFD700",this.stroke-1)}var q=this.size/2,i=Math.floor(this.size/16);var p=o==d?"DRAW":(o==2?"NOUGHTS WIN!":"CROSSES WIN!");p=this.raphael.text(this.size/2,0,p).attr({font:i+"px Helvetica",stroke:"#00CD00"});var g=function(){p.animate({transform:"s2T0,"+q},2000,">",function(){p.animate({transform:"s1T0,"+(2*q)},2000,"<",f)})};var f=function(){p.animate({transform:"s2T0,"+q},2000,">",function(){p.animate({transform:"s1t0,0"},2000,"<",g)})};g()};a.prototype.init=function(){this.raphael.clear();this.padding=Math.floor(this.size*0.012);this.bbox=Math.floor((this.size-2*this.padding)/3);this.sbox=Math.floor((this.bbox-2*this.padding)/3);this.stroke=parseInt(this.size*0.015);this.rect=this.raphael.rect(0,0,this.size,this.size,this.padding).attr({fill:"#fff"});for(var g,k=1;k<=2;k++){g=k*this.bbox+this.padding;this.line(g,this.padding,g,this.size-this.padding,"#1C1C1C",3);this.line(this.padding,g,this.size-this.padding,g,"#1C1C1C",3)}for(var f,k=0;k<3;k++){f=k*this.bbox+2*this.padding;for(var m,g=0;g<3;g++){m=g*this.bbox+2*this.padding;for(var h=this.sbox,l=1;l<=2;l++,h+=this.sbox){this.line(f+h,m,f+h,m+this.bbox-2*this.padding,"#1C1C1C");this.line(m,f+h,m+this.bbox-2*this.padding,f+h,"#1C1C1C")}}}c={isActive:false,isWinner:false,shapes:[]}};a.prototype.resize=function(h,k){var j=c;this.size=parseInt(h);this.raphael.setSize(this.size,this.size);this.init();for(var f,g=0;g<j.shapes.length;g++){f=j.shapes[g];this.shape(f.game,f.pos)}if(j.isWinner){this.winner(j.winner,j.coordinates)}else{if(j.isActive){this.activate(j.events,j.boards)}}};a.prototype.activate=function(f,r){var s=this,g=[],p,t;var h,o,w,v;c.isActive=true;c.events=f;c.boards=r;var j=function(i){s.rect.unmousemove();if(p){p.remove()}if(t){t.remove()}for(var y in g){g[y].remove()}c.isActive=false;f.click(s.getCell(h,o))};var l=function(B){h=B.target.getBBox();var A=false,z=B.layerX||B.offsetX,C=B.layerY||B.offsetY;if(!window.opera){z-=h.x;C-=h.y}if(z>=s.padding&&C>=s.padding&&z<=s.bbox-s.padding&&C<=s.bbox-s.padding){o=s.getSBoxPosition(z,C,h.x,h.y);var i=s.getSCell(h,o);A=i[0]<=2&&i[1]<=2}if(!A){if(t){t.remove()}w=v=d;return}if(o.x!=w||o.y!=v){if(t){t.remove()}if(f.move(s.getCell(h,o))){t=s.raphael.rect(o.x,o.y,s.sbox,s.sbox).attr(b);t.click(j)}w=o.x;v=o.y}};if(r==d){var x,n,m;this.rect.mousemove(function(B){var A=false,z=B.layerX||B.offsetX,C=B.layerY||B.offsetY;if(z>=s.padding&&C>=s.padding&&z<=s.size-s.padding&&C<=s.size-s.padding){x=s.getBBoxPosition(z,C);var i=s.getBCell(x);A=i[0]<=2&&i[1]<=2}if(!A){if(p){p.remove()}if(t){t.remove()}n=m=w=v=d;return}x=s.getBBoxPosition(z,C);if(x.x!=n||x.y!=m){if(p){p.remove();if(t){t.remove()}}p=s.raphael.rect(x.x,x.y,s.bbox,s.bbox).attr(e);p.mousemove(l);n=x.x;m=x.y}})}else{for(var q,k,u=0;u<r.length;u++){k=r[u];q=this.raphael.rect(k[0]*this.bbox+this.padding,k[1]*this.bbox+this.padding,this.bbox,this.bbox).attr(e);q.mousemove(l);g.push(q)}}};return a})();var Game=(function(b){var a=false;var c=function(d,e){if(d){this.board=new GameBoard(d,e)}};c.prototype.addPlayer=function(d){this.player1=new d(this)};c.prototype.addOpposer=function(d){this.player2=new d(this)};c.prototype.init=function(d){a=false;d=d||{};this.mode=d.mode||0;this.player=d.player||1;this.difficulty=d.difficulty||1;this.delay=d.delay||500;this.onwin=d.onwin;this.ondraw=d.ondraw;this.showMoveNumbers=d.showMoveNumbers;this.moves=0;this.last=[];this.game=[];this.player1.init();this.player2.init();if(this.board){this.board.init()}for(var e=0;e<81;e++){this.game[e]=0}};c.prototype.getIndex=function(d){return 9*(d[0][1]*3+d[0][0])+d[1][1]*3+d[1][0]};c.prototype.isEmptyCell=function(e,d){var d=d||this.game;return d[c.prototype.getIndex(e)]==0};c.prototype.isFullBoard=function(g,e){var e=e||this.game;for(var f=0,d=9*(g[1]*3+g[0]);f<9;f++){if(e[f+d]==0){return false}}return true};c.prototype.getNonFullBoards=function(d,h){var d=d||this.game;var h=h||this.last;if(!c.prototype.isFullBoard(h[1],d)){return[h[1]]}var g=[];for(var f=0;f<3;f++){for(var e=0;e<3;e++){if(!c.prototype.isFullBoard([f,e],d)){g.push([f,e])}}}return g};c.prototype.hasWinner=function(){var g=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(var e=0;e<81;e+=9){for(var d=0,f;d<8;d++){f=g[d];if(this.game[e+f[0]]==this.player&&this.game[e+f[1]]==this.player&&this.game[e+f[2]]==this.player){return[[Math.floor((e%27)/9),Math.floor(e/27)],[f[0]%3,Math.floor(f[0]/3)],[f[1]%3,Math.floor(f[1]/3)],[f[2]%3,Math.floor(f[2]/3)]]}}}return false};c.prototype.cell=function(d){this.last=d;this.game[this.getIndex(this.last)]=this.player};c.prototype.move=function(){a=true;this.moves++;if(this.moves>1){this.player=this.player==1?2:1;if(this.mode==3&&this.delay>=0){var d=this;setTimeout(function(){if(d.player==1){d.player1.move()}else{d.player2.move()}},this.delay);return}}if(this.player==1){this.player1.move()}else{this.player2.move()}};c.prototype.inGame=function(){return a};c.prototype.win=function(d){a=false;if(this.board){this.board.winner(this.player,d)}if(this.onwin){this.onwin(this.player)}};c.prototype.draw=function(){if(this.board){this.board.winner()}if(this.ondraw){this.ondraw()}};return c})();var Human=(function(b){var a=function(c){this.game=c;this.events={}};a.prototype.init=function(){var d=this;var c=function(f){return d.game.isEmptyCell(f)};var e=function(g){d.game.board.shape(d.game,g,true);d.game.cell(g);var f=d.game.hasWinner();if(f!==false){d.game.win(f)}else{d.game.move()}};this.events={move:c,click:e}};a.prototype.move=function(){if(this.game.moves==1){this.game.board.activate(this.events)}else{var c=this.game.getNonFullBoards();if(c.length==0){this.game.draw()}else{this.game.board.activate(this.events,c)}}};return a})();var Bot=(function(f){var c=false,e;var a={pppXXXXXX:1000000,XXXpppXXX:1000000,XXXXXXppp:1000000,pXXpXXpXX:1000000,XpXXpXXpX:1000000,XXpXXpXXp:1000000,pXXXpXXXp:1000000,XXpXpXpXX:1000000,pp0XXXXXX:8,p0pXXXXXX:8,"0ppXXXXXX":8,XXXpp0XXX:8,XXXp0pXXX:8,XXX0ppXXX:8,XXXXXXpp0:8,XXXXXXp0p:8,XXXXXX0pp:8,pXXpXX0XX:8,pXX0XXpXX:8,"0XXpXXpXX":8,XpXXpXX0X:8,XpXX0XXpX:8,X0XXpXXpX:8,XXpXXpXX0:8,XXpXX0XXp:8,XX0XXpXXp:8,pXXXpXXX0:8,pXXX0XXXp:8,"0XXXpXXXp":8,XXpXpX0XX:8,XXpX0XpXX:8,XX0XpXpXX:8,oopXXXXXX:16,opoXXXXXX:16,pooXXXXXX:16,XXXoopXXX:16,XXXopoXXX:16,XXXpooXXX:16,XXXXXXoop:16,XXXXXXopo:16,XXXXXXpoo:16,oXXoXXpXX:16,oXXpXXoXX:16,pXXoXXoXX:16,XoXXoXXpX:16,XoXXpXXoX:16,XpXXoXXoX:16,XXoXXoXXp:16,XXoXXpXXo:16,XXpXXoXXo:16,oXXXoXXXp:16,oXXXpXXXo:16,pXXXoXXXo:16,XXoXoXpXX:16,XXoXpXoXX:16,XXpXoXoXX:16,po0XXXXXX:4,p0oXXXXXX:4,"0poXXXXXX":4,"0opXXXXXX":4,o0pXXXXXX:4,op0XXXXXX:4,XXX0opXXX:4,XXX0poXXX:4,XXXpo0XXX:4,XXXp0oXXX:4,XXXo0pXXX:4,XXXop0XXX:4,XXXXXXp0o:4,XXXXXXpo0:4,XXXXXX0po:4,XXXXXX0op:4,XXXXXXop0:4,XXXXXXo0p:4,pXX0XXoXX:4,pXXoXX0XX:4,oXX0XXpXX:4,oXXpXX0XX:4,"0XXoXXpXX":4,"0XXpXXoXX":4,XpXX0XXoX:4,XpXXoXX0X:4,XoXX0XXpX:4,XoXXpXX0X:4,X0XXoXXpX:4,X0XXpXXoX:4,XXpXX0XXo:4,XXpXXoXX0:4,XXoXX0XXp:4,XXoXXpXX0:4,XX0XXoXXp:4,XX0XXpXXo:4,pXXX0XXXo:4,pXXXoXXX0:4,"0XXXoXXXp":4,"0XXXpXXXo":4,oXXX0XXXp:4,oXXXpXXX0:4,XXpX0XoXX:4,XXpXoX0XX:4,XX0XoXpXX:4,XX0XpXoXX:4,XXoX0XpXX:4,XXoXpX0XX:4};var b=function(h,g){return Math.floor(Math.random()*(parseInt(g)+1))+parseInt(h)};var d=function(g,h){this.game=g;this.logic=h||a};d.prototype.init=function(){if(this.worker){this.worker.terminate();if(typeof document!="undefined"){document.body.style.cursor="default"}}};d.prototype.move=function(){if(!this.game.inGame()){return}if(typeof document!="undefined"){document.body.style.cursor="wait"}var g=this,h=function(i){if(typeof document!="undefined"){document.body.style.cursor="default"}if(i.length==0){g.game.draw();return}g.game.cell(i[b(0,i.length-1)]);if(g.game.board){g.game.board.shape(g.game,g.game.last,true)}var j=g.game.hasWinner();if(j!==false){g.game.win(j)}else{g.game.move()}};if(this.game.moves==1){h([[[b(0,2),b(0,2)],[b(0,2),b(0,2)]]])}else{if(this._noWorker||typeof Worker=="undefined"){h(this.getOptimalMoves(this.game.getNonFullBoards()))}else{this.worker=new Worker("bot.js");this.worker.addEventListener("message",function(i){h(i.data)},false);this.worker.postMessage({logic:JSON.parse(localStorage.getItem("ttt-logic"))||a,boards:this.game.getNonFullBoards(),game:{player:this.game.player,difficulty:this.game.difficulty,game:this.game.game,moves:this.game.moves}})}}};d.prototype.getOptimalMoves=function(l,u){var h=[],v=[],r=-1000000000,u=u||this.game;var g=2*u.difficulty+1,s=u.player==2?1:2;if(g>=7){if(u.moves<=18){g=5}else{if(g>=9&&u.moves<=27){g=7}}}for(var q,t,p,m=0;m<l.length;m++){p=l[m];for(var o=0;o<3;o++){for(var n=0;n<3;n++){t=[p,[o,n]];if(Game.prototype.isEmptyCell(t,u.game)){q=this.getMoveEstimate(t,{level:g,game:u.game.slice(),player:u.player,opposer:s});v.push([q,t]);if(q>r){r=q}}}}}for(var o=0;o<v.length;o++){if(v[o][0]==r){h.push(v[o][1])}}return h};d.prototype.getMoveEstimate=function(v,h){var u,n=c2=c3=c4="",t=0;h.game[Game.prototype.getIndex(v)]=h.player;u=9*(3*v[0][1]+v[0][0]);for(var w,o=0;o<3;o++){for(var m=0;m<3;m++){w=h.game[u]==h.player?"p":(h.game[u]==h.opposer?"o":"0");if(v[1][0]==m){n+=w}else{n+="X"}if(v[1][1]==o){c2+=w}else{c2+="X"}if(v[1][0]==v[1][1]&&o==m){c3+=w}else{c3+="X"}if(v[1][0]+v[1][1]==2&&o+m==2){c4+=w}else{c4+="X"}u++}}t+=this.logic[n]||0;t+=this.logic[c2]||0;t+=this.logic[c3]||0;t+=this.logic[c4]||0;if(h.level>0&&t<1000000){var g=Game.prototype.getNonFullBoards(h.game,v),r=-1000000000;for(var q,p,l=0;l<g.length;l++){q=g[l];for(var o=0;o<3;o++){for(var m=0;m<3;m++){v=[q,[o,m]];if(Game.prototype.isEmptyCell(v,h.game)){p=this.getMoveEstimate(v,{level:h.level-1,game:h.game.slice(),player:h.opposer,opposer:h.player,factors:h.factors});if(p>r){r=p}}}}}t-=r}return t};d.prototype.evolve=function(w){if(!(w instanceof Array)&&!w){c=false;if(e){e.terminate()}return}c=true;var l,n;var r=[["pppXXXXXX","XXXpppXXX","XXXXXXppp","pXXpXXpXX","XpXXpXXpX","XXpXXpXXp","pXXXpXXXp","XXpXpXpXX"],["p00XXXXXX","pXX0XX0XX","pXXX0XXX0","00pXXXXXX","XXpXX0XX0","XXpX0X0XX","XXXXXXp00","0XX0XXpXX","XX0X0XpXX","XXXXXX00p","XX0XX0XXp","0XXX0XXXp"],["0p0XXXXXX","XpXX0XX0X","0XXpXX0XX","XXXp00XXX","X0XX0XXpX","XXXXXX0p0","XXX00pXXX","XX0XXpXX0"],["XXX0p0XXX","X0XXpXX0X","0XXXpXXX0","XX0XpX0XX"],["oopXXXXXX","XXpXXoXXo","XXpXoXoXX","pooXXXXXX","pXXoXXoXX","pXXXoXXXo","XXXXXXoop","XXoXXoXXp","oXXXoXXXp","XXXXXXpoo","oXXoXXpXX","XXoXoXpXX"],["opoXXXXXX","XpXXoXXoX","XXXoopXXX","XXoXXpXXo","XXXXXXopo","XoXXoXXpX","XXXpooXXX","oXXpXXoXX"],["XXXopoXXX","XoXXpXXoX","oXXXpXXXo","XXoXpXoXX"],["pp0XXXXXX","XX0XpXpXX","XX0XXpXXp","0ppXXXXXX","0XXXpXXXp","0XXpXXpXX","XXXXXX0pp","XXpXpX0XX","pXXpXX0XX","XXXXXXpp0","XXpXXpXX0","pXXXpXXX0"],["p0pXXXXXX","X0XXpXXpX","XXXpp0XXX","XXpXX0XXp","XXXXXXp0p","XpXXpXX0X","XXX0ppXXX","pXX0XXpXX"],["XXXp0pXXX","XpXX0XXpX","pXXX0XXXp","XXpX0XpXX"],["po0XXXXXX","p0oXXXXXX","pXXoXX0XX","pXX0XXoXX","pXXX0XXXo","pXXXoXXX0","o0pXXXXXX","0opXXXXXX","XXpXX0XXo","XXpXXoXX0","XXpX0XoXX","XXpXoX0XX","XXXXXXp0o","XXXXXXpo0","0XXoXXpXX","oXX0XXpXX","XX0XoXpXX","XXoX0XpXX","XXXXXX0op","XXXXXXo0p","XX0XXoXXp","XXoXX0XXp","0XXXoXXXp","oXXX0XXXp"],["0poXXXXXX","op0XXXXXX","XpXX0XXoX","XpXXoXX0X","XXX0opXXX","XXXo0pXXX","XX0XXpXXo","XXoXXpXX0","XXXXXX0po","XXXXXXop0","XoXX0XXpX","X0XXoXXpX","XXXpo0XXX","XXXp0oXXX","0XXpXXoXX","oXXpXX0XX"],["XXX0poXXX","XXXop0XXX","XoXXpXX0X","X0XXpXXoX","0XXXpXXXo","oXXXpXXX0","XX0XpXoXX","XXoXpX0XX"]];var p=JSON.parse(localStorage.getItem("ttt-data"));if(!p){l=[];n=1;for(var q=0,s;q<10;q++){s={};for(var o=0;o<8;o++){s[r[0][o]]=1000000}for(var o=1,t,u;o<=12;o++){t=r[o];u=b(0,24);for(var m=0;m<t.length;m++){s[t[m]]=u}}l.push(s)}}else{l=p.bots;n=p.population}var h=function(C){localStorage.setItem("ttt-data",JSON.stringify({bots:l,population:n,logic:C.data.parent1}));l=[];var E=C.data.parent1,D=C.data.parent2;for(var B=0,y,x,v;B<10;B+=2){x={};v={};for(var A=0;A<8;A++){x[r[0][A]]=v[r[0][A]]=1000000}y=b(2,12);for(var A=1,F,H,G;A<=12;A++){F=r[A];if(A<y){H=D[F[0]];G=E[F[0]]}else{H=E[F[0]];G=D[F[0]]}if(b(0,100)<30){H=Math.abs(H+1-2*b(0,1));G=Math.abs(G+1-2*b(0,1));if(H>24){H=24}if(G>24){G=24}}for(var z=0;z<F.length;z++){x[F[z]]=H;v[F[z]]=G}}l.push(x,v)}if(c){n++;g()}};var g=function(){if(w){w(n,l)}e=new Worker("evolve.js");e.addEventListener("message",h,false);e.postMessage(l)};g()};d.prototype.applyLogic=function(){var g=JSON.parse(localStorage.getItem("ttt-data"));if(g){localStorage.setItem("ttt-logic",JSON.stringify(g.logic))}};d.prototype.restoreLogic=function(){localStorage.removeItem("ttt-logic")};d.prototype.resetLogic=function(){localStorage.removeItem("ttt-data");localStorage.removeItem("ttt-logic")};return d})();var TicTacToe=(function(b){var a=function(c,d){this.game=new Game(c,d)};a.prototype.start=function(c){var d=c.mode||0;if(d<0){d=0}if(d>3){d=3}this.game.addPlayer(d==0||d==2?Human:Bot);this.game.addOpposer(d==1||d==2?Human:Bot);this.game.init(c);this.game.move()};a.prototype.stop=function(){if(this.game.inGame()){this.game.init()}};return a})();